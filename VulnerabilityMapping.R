#Matthew Faith, 05/11/2025

#load libraries
library(readr)
library(dplyr)
library(tidyverse)
library(raster)
library(countrycode)

#setwd
setwd("C:/Users/matthewfaith/OneDrive - University of Plymouth/PhD/Chapter 5 - Fishing effort for assessing fisheries climate risks/Data/")

#Load_data
processed_data_bySAUP <- read_csv("Pelagic_Nom_201417_mean_bySAUP.csv")
processed_data_bySAUP <- processed_data_bySAUP %>%
  rename(NomActive = Pelagic_Nom_201417_mean_effort)

processed_data_bySAUP_original <- processed_data_bySAUP
vulnerability <- read_csv("IndicatorsScaled_SensPlusAC.csv")

#add ccodes
SAUPtoCountry <- read_csv("Input/SAUPtoCountry.csv")

#vulnerability <- dplyr::left_join(vulnerability, SAUPtoCountry[c("Country", "SAUP")], by = c('Country' = 'Country'))
CellstoLME_EEZ <- read_csv("Input/CellstoLME_EEZ.csv")

combined_data <- dplyr::left_join(processed_data_bySAUP, vulnerability[c("SAUP", "Country", "VulnerabilityIndicator")], by = c('SAUP' = 'SAUP'))

#Assess level of missing data
Missing_data <- filter(combined_data, is.na(combined_data$VulnerabilityIndicator) == TRUE)


#Missing_data_countries <- aggregate(Missing_data$NomActive, FUN=sum, 
#                           by=list(SAUP=Missing_data$SAUP))
#Missing_data_countries <- Missing_data_countries %>% rename(NomActive = x)

Complete_data <- filter(combined_data, is.na(combined_data$VulnerabilityIndicator) == FALSE)

print(sum(Missing_data$NomActive))
print(sum(combined_data$NomActive))

#Calculate percentage of fishing effort captured by vulnerability data
print(100-(100*((sum(Missing_data$NomActive))/(sum(combined_data$NomActive)))))

#Calcualte vulnerability of gridcells
#Complete_data$effort_vuln <- (Complete_data$NomActive*Complete_data$Protein)
#Complete_data$effort_vuln <- (Complete_data$NomActive*Complete_data$Employment)
#Complete_data$effort_vuln <- (Complete_data$NomActive*Complete_data$Landings)
Complete_data$effort_vuln <- (Complete_data$NomActive*Complete_data$VulnerabilityIndicator)

Complete_vuln <- aggregate(Complete_data$effort_vuln, FUN=sum, 
                          by=list(Lat=Complete_data$Lat, Lon=Complete_data$Lon, loc=Complete_data$loc))
Complete_vuln <- Complete_vuln %>% rename(effort_vuln = x)

Complete_Eff <- aggregate(Complete_data$NomActive, FUN=sum, 
                           by=list(Lat=Complete_data$Lat, Lon=Complete_data$Lon, loc=Complete_data$loc))
Complete_Eff <- Complete_Eff %>% rename(NomActive = x)


combined_complete <- dplyr::left_join(Complete_vuln, Complete_Eff[c('loc', 'NomActive')], by = c('loc' = 'loc'))

combined_complete$Vulnerability <- combined_complete$effort_vuln/combined_complete$NomActive

hist(combined_complete$Vulnerability)

write.csv(combined_complete,"Fishingground_Totalvulnerability_FINAL.csv", row.names = FALSE)

#flag low data grid cells
#Calculate total fishing in cell
processed_data_bySAUP <- aggregate(processed_data_bySAUP$NomActive, FUN=sum, 
                          by=list(Lat=processed_data_bySAUP$Lat, Lon=processed_data_bySAUP$Lon, loc=processed_data_bySAUP$loc))
processed_data_bySAUP <- processed_data_bySAUP %>% rename(NomActive_original = x)


combined_fishing_effs <- dplyr::left_join(processed_data_bySAUP, combined_complete[c('loc', 'NomActive')], by = c('loc' = 'loc'))

combined_fishing_effs$proportion <- (combined_fishing_effs$NomActive/combined_fishing_effs$NomActive_original)

combined_fishing_effs <- filter(combined_fishing_effs, combined_fishing_effs$proportion < 0.5)
combined_fishing_effs <- data.frame(Lat = combined_fishing_effs$Lat, Lon = combined_fishing_effs$Lon, proportion = combined_fishing_effs$proportion)
combined_fishing_effs$proportion = 1
#write.csv(combined_fishing_effs,"Fishing/Fishing Dependence/NewVulnerability/Fishingground_Totalvulnerability_FINAL_lessthanhalfdata.csv", row.names = FALSE)

missing_dependence <- unique(Missing_data$SAUP)

CellstoLME_EEZ$CCode <- countryname(CellstoLME_EEZ$EEZ, destination = "iso3c", warn = TRUE)
CellstoLME_EEZ$CCode[CellstoLME_EEZ$EEZ == "Dominican Rp"] <- "DOM"
CellstoLME_EEZ$CCode[CellstoLME_EEZ$EEZ == "Micronesia"] <- "FSM"
CellstoLME_EEZ$CCode[CellstoLME_EEZ$EEZ == "Serbia Montenegro"] <- "MNE"
CellstoLME_EEZ$CCode[CellstoLME_EEZ$EEZ == "Untd Arab Em"] <- "ARE"

CellstoLME_EEZ$SAUP <- countryname(CellstoLME_EEZ$EEZ, destination = "iso3n", warn = TRUE)
CellstoLME_EEZ$SAUP[CellstoLME_EEZ$EEZ == "Dominican Rp"] <- 214
CellstoLME_EEZ$SAUP[CellstoLME_EEZ$EEZ == "Micronesia"] <- 583
CellstoLME_EEZ$SAUP[CellstoLME_EEZ$EEZ == "Serbia Montenegro"] <- 892
CellstoLME_EEZ$SAUP[CellstoLME_EEZ$EEZ == "Untd Arab Em"] <- 784

#Check SAUP to Country in fishing effort data
Missing_SAUPs <- dplyr::left_join(SAUPtoCountry, processed_data_bySAUP_original[c("SAUP", "loc")], by = c('SAUP' = 'SAUP'))
Missing_SAUPs <- filter(Missing_SAUPs, is.na(Missing_SAUPs$loc) == TRUE)
Missing_SAUPs <- unique(Missing_SAUPs$SAUP)
Missing <- unique(c(Missing_SAUPs, missing_dependence))

Missing <- data.frame(matrix(unlist(Missing), nrow=length(Missing), byrow=TRUE))
Missing$val = 1
colnames(Missing) <- c("SAUP", "SAUP_missing") 

Missing_map <- dplyr::left_join(CellstoLME_EEZ, Missing[c("SAUP", "SAUP_missing")], by = c('SAUP' = 'SAUP'))
Missing_map <- filter(Missing_map, Missing_map$SAUP_missing == 1)
Missing_map <- data.frame(Lat = Missing_map$Lat, Lon = Missing_map$Lon, proportion = Missing_map$SAUP_missing)
#join combined_fishing_effs and Missing_map
Missing_map <- rbind(Missing_map, combined_fishing_effs)

write.csv(Missing_map,"Missing_Data.csv", row.names = FALSE)

